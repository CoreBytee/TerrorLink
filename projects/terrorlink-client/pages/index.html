<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>

        <style>
            html {
                margin: 0;
                padding: 0;
                min-height: 100vh;
            }

            body {
                height: 100vh;
                background-color: #131313;
                color: white;
                font-family: Arial, Helvetica, sans-serif;
                margin: 0;
                text-align: center;
            }

            body {
                display: flex;
                flex-direction: column;
                /* justify-content: center; */
                align-items: center;

                gap: 20px;
                padding-top: 20px;
            }

            button.link {
                appearance: none;
                background-color: transparent;
                border: none;
                color: rgb(59, 59, 255);
                text-decoration: underline;
                cursor: pointer;
            }

            .inline-avatar {
                height: 15px;
            }

            * {
                box-sizing: border-box;
            }

            * {
                margin: 0;
                padding: 0;
            }

            .voice-state {
                display: flex;
                flex-direction: row;
                gap: 10px;

                height: 80px;
                width: 80%;

                canvas {
                    background-color: #161616;
                    height: 100%;
                    width: 100%;
                    border-radius: 20px;
                }
            }
        </style>

        <script>
            let state = undefined
            async function fetchState() {
                const response = await fetch("/api/state")
                state = await response.json()
                return state
            }

            async function update() {
                requestAnimationFrame(update)
                const state = await fetchState()

                { // Steam state
                    const steamAccountState = document.getElementById("steam-account-state")
                    const steamAccountAvatar = document.getElementById("steam-account-avatar")
                    const steamAccountButton = document.getElementById("steam-account-button")

                    const steamAccount = state.steamAccount

                    steamAccountState.innerText = steamAccount ? steamAccount.displayName : "Unknown"
                    steamAccountState.style.color = steamAccount ? "green" : "red"

                    steamAccountAvatar.src = steamAccount ? steamAccount.avatarUrl : ""
                    steamAccountAvatar.style.display = steamAccount ? "inline" : "none"

                    steamAccountButton.innerText = steamAccount ? "Disconnect" : "Connect"
                }

                { // Websocket state
                    const websocketConnectionState = document.getElementById("websocket-connection-state")
                    websocketConnectionState.innerText = state.websocket ? "Connected" : "Disconnected"
                    websocketConnectionState.style.color = state.websocket ? "green" : "red"
                }

                { // Websocket stats
                    document.getElementById("websocket-transferred-count").innerText = `WS Messages: ${state.messageCount}`
                    document.getElementById("websocket-transferred-bytes").innerText = `WS Bytes: ${state.bytesCount}`
                    document.getElementById("websocket-ping").innerText = `WS Ping: ${state.ping} ms`
                }

                { // Frequency graph
                    const canvas = document.querySelector("canvas")
                    const context = canvas.getContext("2d")
                    const data = state.microphone.frequencyData

                    const width = canvas.width = canvas.clientWidth
                    const height = canvas.height = canvas.clientHeight

                    const barWidth = width / data.length
                    const barHeight = height / 255

                    context.clearRect(0, 0, width, height)
                    context.fillStyle = "white"

                    data.forEach((value, i) => {
                        const x = i * barWidth
                        const y = height - value * barHeight

                        context.fillRect(x, y, barWidth, height - y)
                    })
                }
            }

            document.addEventListener(
                "DOMContentLoaded",
                () => {
                    update()

                    document.getElementById("steam-account-button").addEventListener("click", async () => {
                        state.steamAccount ?
                            await fetch("/api/logout/steam", { method: "POST" }) : await fetch("/api/login/steam", { method: "POST" })
                    })

                    document.getElementById("volume-slider").addEventListener("input", async (event) => {
                        const value = event.target.value
                        document.querySelector("label[for=volume-slider]").innerText = `Volume: ${value}`
                        await fetch("/api/volume", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                volume: value
                            })
                        })
                    })
                }
            )
        </script>
    </head>

    <body>
        <div>
            <p>
                Steam:
                <img src="" alt="steam-avatar" id="steam-account-avatar" class="inline-avatar">
                <span id="steam-account-state">Unknown</span> - <button class="link"
                    id="steam-account-button">Connect</button>
            </p>
        </div>

        <div>
            <p>Websocket: <span id="websocket-connection-state">Disconnected</span></p>
        </div>

        <div>
            <label for="volume-slider">Volume: 100</label><br>
            <input type="range" name="" id="volume-slider" min="0" max="100" value="100">
        </div>

        <div>
            <h4 id="websocket-transferred-count"></h4>
            <h4 id="websocket-transferred-bytes"></h4>
            <h4 id="websocket-ping"></h4>
        </div>

        <div class="voice-state">
            <!-- <button>Mute</button>
            <button>Deafen</button> -->
            <canvas></canvas>
        </div>

    </body>

</html>